// JavaScript Document
/*publish time:2011-10-20 09:06:07*/
KISSY.add("rate/addrate",function(C){var J=C.Event,D=C.DOM,F=C.namespace("rate"),H=C.namespace("ui"),E=C.namespace("util"),I=["\u5f88\u4e0d\u6ee1\u610f","\u4e0d\u6ee1\u610f","\u4e00\u822c","\u6ee1\u610f","\u5f88\u6ee1\u610f"],G="st-show-msg-box";function A(O,N,L){var K=this;K.elbox=C.one(O);K.el_share=K.elbox.one(".rate-share");K.el_annoy=K.elbox.one(".rate-annoy");K.id=K.elbox.attr("data-id");K.form=N;K.el_msg_box=K.elbox.one(".rate-msg-box");K.el_msg_input=K.elbox.one(".rate-msg");K.el_ctl_star=K.elbox.one(".rate-control-stars");K.ratecontrol=K.elbox.one(".rate-controll");K.rateradios=K.ratecontrol.all("input");K.config=L;new H.PlaceHolder(K.el_msg_input[0],{elLabel:K.elbox.one(".ph-label")[0]});var M=new H.WordCounter(K.el_msg_input);M.on("countupdate",function(Q){var P=K.el_msg_box.one(".r-t-counter"),R=500-Q.count;P.html(Math.max(R,0))});K.elbox.on("click",function(P){var Q=C.one(P.target);if(Q.hasClass("show-msg-box")){P.halt();K.showComment(true)}else{if(Q.hasClass("close-msg-box")){P.halt();K.hideComment()}}});if(K.el_annoy){K.el_annoy.on("click",function(P){K.fire("annoychange",{checked:K.el_annoy[0].checked})})}if(K.rateradios){K.rateradios.on("click",function(P){var Q=C.one(P.target);K.fire("ratechange");K.initRateScore()});K.initRateScore()}K.on("annoychange",function(Q){var P=K.el_share[0];if(K.el_annoy[0].checked){P.disabled=true;P.checked=false}else{P.disabled=false}});K.on("score_change",function(){K.showComment(false)})}C.augment(A,C.EventTarget,{initRateScore:function(){var R=this,P,M,N="",K=R.elbox.one(".rate-score"),O=R.config.placeholder,L=O.BAD,S=O.NORMAL,Q=R.elbox.attr("data-prompt")||O.GOOD;P=R.getRateScore();if(typeof P=="number"){switch(P){case -1:M=L;N="bad";break;case 1:M=Q;N="good";break;case 0:M=S;N="normal";break}if(P<=0){R.elbox.addClass("rate-level-normal")}else{R.elbox.removeClass("rate-level-normal")}P=P>0?"+"+P:""+P;K.html(P+"\u5206").attr("class","rate-score "+N);if(P==="0"){K.html("\u4e0d\u52a0\u5206")}R.elbox.one(".ph-label").html(M);R.fire("score_change")}else{K.html("&nbsp;")}},checkForm:function(){var M=this,K=M.el_msg_input,L=C.trim(K.val()),O=M.getRateScore(),N="";if(L&&O===null){N="\u53d1\u8868\u8bc4\u8bba\u7684\u5b9d\u8d1d\u5fc5\u987b\u9009\u62e9\u597d\u3001\u4e2d\u3001\u5dee\u8bc4";this.showComment(true)}if(O!==null&&O<=0&&!L){N="\u4e2d\u5dee\u8bc4\u4e00\u5b9a\u8981\u8bf4\u660e\u539f\u56e0\u54e6";K[0].focus()}if(N){M.showError(N);document.body.scrollTop=M.elbox.offset().top;return N}},showError:function(M){var K=this;var L=K.el_msg_box.one(".msg");if(!L){L=C.one(D.create('<div class="msg">'));L.insertBefore(K.el_msg_box.one(".textinput"))}L.html('<p class="stop">'+M+"</p>").show()},hideError:function(){var K=this;var L=K.el_msg_box.all(".msg");if(L&&L.length>0){L.hide()}},showComment:function(K){var L=this;L.elbox.addClass(G);if(K){C.later(function(){L.el_msg_input[0].focus()},100)}},hideComment:function(){var L=this.getRateScore();var M=C.trim(this.el_msg_input.val());var K=M?"\u4fee\u6539\u8bc4\u8bba":"\u6dfb\u52a0\u8bc4\u8bba";if(L!==null&&L<1&&M===""){this.el_msg_input[0].focus();return }this.elbox.one("a.show-msg-box").html(K);this.elbox.removeClass(G)},getRateScore:function(){var K=this.rateradios,L;if(!K){return }K.each(function(M){if(C.one(M)[0].checked){L=C.one(M).val()}});if(!L){return null}return parseInt(L,10)},setAnnoy:function(L){if(!this.el_annoy){return }var K=this,M=K.el_annoy[0];if(M.disabled){return }if(M.checked!=L){M.checked=L;K.fire("annoychange",{checked:L})}},setGoodRate:function(K){this.elbox.one(".good-rate")[0].checked=K;this.initRateScore()}});function B(P){var L;var S=[];var O=C.all(".rate-box");var M=C.one("#rateListForm");var T=[];var R=false;O.each(function(X,W){S.push(new A(X,M,P));if(W===O.length-1){C.one(X).addClass("rate-box-last")}});C.Event.on(S,"ratechange",function(W){C.one("#rate-good-all")[0].checked=false});var V=C.one("#annoy-all"),Q=false;J.on(S,"annoychange",function(W){if(!W.checked){V[0].checked=false}});if(V){V.on("click",function(){var W=C.one(this)[0].checked;C.each(S,function(X){X.setAnnoy(W)});Q=true})}var K=C.one("#rate-good-all");if(K){K.on("click",function(){var W=C.one(this)[0].checked;C.each(S,function(X){X.setGoodRate(W)})})}var N=C.one("ul.stars");if(N&&N.all(".rate-stars").length>0){N.all(".rate-stars").each(function(W,Y){var a=C.one(W).attr("data-type"),Z=a?P.star_tooltip[a]:[];var X=new H.SimpleStar(W,{tooltips:Z,levelText:I});T.push(X)})}function U(){C.one("#starstip").hide();J.remove(T,"change",U)}J.on(T,"change",U);M.on("submit",function(Z){var Y,c=false,b=false,X=false;Z.halt();C.each(S,function(e){e.hideError();var d=e.checkForm();c=c||d});if(c){return }C.each(S,function(d){if(d.getRateScore()!==null){b=true}});C.each(T,function(d){if(d.index()!==-1){X=true}});if((!b&&S.length>0||S.length===0)&&(!X&&T.length>0||T.length===0)){Y=M.one("div.submitbox").one("div.msg");if(!Y){Y=C.one(D.create('<div class="msg">'));Y.insertBefore(M.one("div.submitbox").one("button"))}C.later(function(){Y.html('<p class="error">\u4f60\u8fd8\u6ca1\u6709\u6dfb\u52a0\u4efb\u4f55\u8bc4\u4ef7,\u4e0d\u8981\u5077\u61d2\u54e6\uff0c\u4eb2!</p>').show()},50);return }if(!E.LoginCheck){M[0].submit()}var W=M.one("button.submit"),a=W.html();W.prop("disabled",true).html("\u63d0\u4ea4\u4e2d...");if(!L){L=new E.LoginCheck({ajaxURL:M.attr("data-checkLoginJson"),callbackURL:M.attr("data-checkLoginCallback"),success:function(d){if(C.isObject(d)&&C.isArray(d.update)){C.each(d.update,function(f){var e=M[0].elements[f.name];if(e){e.value=f.value}})}W.html(a);M[0].submit()},cancel:function(){W.html(a).prop("disabled",false)}})}L.start()})}F.rateInit=B});